#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —à–∞—Ö–º–∞—Ç–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞
"""

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), 'core'))

from chess_engine_wrapper import ChessEngineWrapper

def test_engine_basics():
    """–¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–≤–∏–∂–∫–∞"""
    print("‚ôî –¢–ï–°–¢ –®–ê–•–ú–ê–¢–ù–û–ì–û –î–í–ò–ñ–ö–ê ‚ôö")
    print("=" * 40)
    
    # –°–æ–∑–¥–∞–µ–º –¥–≤–∏–∂–æ–∫
    engine = ChessEngineWrapper()
    
    # –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
    print("\n1. –ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è:")
    engine.print_board()
    
    # –ü—Ä–æ–≤–µ—Ä–∏–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ö–æ–¥–∞
    print("\n2. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ö–æ–¥–∞ e2-e4:")
    is_valid = engine.is_valid_move((6, 4), (4, 4))  # e2 to e4
    print("–•–æ–¥ e2-e4 –≤–∞–ª–∏–¥–µ–Ω:", is_valid)
    
    # –°–¥–µ–ª–∞–µ–º —Ö–æ–¥
    print("\n3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ö–æ–¥–∞ e2-e4:")
    success = engine.make_move((6, 4), (4, 4))
    print("–•–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω:", success)
    
    if success:
        engine.print_board()
        
        # –ü—Ä–æ–≤–µ—Ä–∏–º —à–∞—Ö
        print("\n4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞—Ö–∞:")
        is_white_check = engine.is_king_in_check(True)
        is_black_check = engine.is_king_in_check(False)
        print("–ë–µ–ª—ã–π –∫–æ—Ä–æ–ª—å –ø–æ–¥ —à–∞—Ö–æ–º:", is_white_check)
        print("–ß–µ—Ä–Ω—ã–π –∫–æ—Ä–æ–ª—å –ø–æ–¥ —à–∞—Ö–æ–º:", is_black_check)

def test_castling_functionality():
    """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–æ–∫–∏—Ä–æ–≤–∫–∏"""
    print("\n\n‚ôú –¢–ï–°–¢ –†–û–ö–ò–†–û–í–ö–ò ‚ôú")
    print("=" * 30)
    
    engine = ChessEngineWrapper()
    
    print("–ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è:")
    engine.print_board()
    
    # –ü—Ä–æ–≤–µ—Ä–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    print("\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–æ–∫–∏—Ä–æ–≤–∫–∏:")
    kingside_valid = engine.is_castling_valid((7, 4), (7, 6), True)  # e1 to g1
    queenside_valid = engine.is_castling_valid((7, 4), (7, 2), True)  # e1 to c1
    
    print("–ö–æ—Ä–æ—Ç–∫–∞—è —Ä–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∞–ª–∏–¥–Ω–∞:", kingside_valid)
    print("–î–ª–∏–Ω–Ω–∞—è —Ä–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∞–ª–∏–¥–Ω–∞:", queenside_valid)
    
    # –°–¥–µ–ª–∞–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–æ–¥—ã
    print("\n–û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø—É—Ç—å –¥–ª—è —Ä–æ–∫–∏—Ä–æ–≤–∫–∏...")
    
    # e4, e5, Nf3, Nf6, Bc4, Bc5
    moves = [(6, 4), (4, 4)], [(1, 4), (3, 4)], [(7, 6), (5, 5)], [(0, 6), (2, 5)], [(7, 5), (4, 2)], [(0, 5), (3, 2)]
    
    for i, (from_pos, to_pos) in enumerate(moves):
        engine.make_move(from_pos, to_pos)
        if i == 5:  # –ü–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ö–æ–¥–∞
            print("–ü–æ–∑–∏—Ü–∏—è –ø–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤:")
            engine.print_board()
            
            # –ü—Ä–æ–≤–µ—Ä–∏–º —Ä–æ–∫–∏—Ä–æ–≤–∫—É —Å–Ω–æ–≤–∞
            print("\n–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ—Å–ª–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤:")
            kingside_valid = engine.is_castling_valid((7, 4), (7, 6), True)
            print("–ö–æ—Ä–æ—Ç–∫–∞—è —Ä–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∞–ª–∏–¥–Ω–∞:", kingside_valid)
            
            if kingside_valid:
                print("\n–í—ã–ø–æ–ª–Ω—è–µ–º —Ä–æ–∫–∏—Ä–æ–≤–∫—É:")
                castling_success = engine.make_move((7, 4), (7, 6))
                print("–†–æ–∫–∏—Ä–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞:", castling_success)
                
                if castling_success:
                    engine.print_board()
                    print("‚úÖ –†–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
                    
                    # –ü—Ä–æ–≤–µ—Ä–∏–º –ø–æ–∑–∏—Ü–∏–∏ –∫–æ—Ä–æ–ª—è –∏ –ª–∞–¥—å–∏
                    king_pos = None
                    rook_pos = None
                    for row in range(8):
                        for col in range(8):
                            piece = engine.board_state[row][col]
                            if piece == 'K':
                                king_pos = (row, col)
                            elif piece == 'R' and col == 5:  # –õ–∞–¥—å—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞ f1
                                rook_pos = (row, col)
                    
                    print(f"–ü–æ–∑–∏—Ü–∏—è –∫–æ—Ä–æ–ª—è: {king_pos}")
                    print(f"–ü–æ–∑–∏—Ü–∏—è –ª–∞–¥—å–∏: {rook_pos}")
                    
                    if king_pos == (7, 6) and rook_pos == (7, 5):
                        print("‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ —Ä–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã!")
                    else:
                        print("‚ùå –û—à–∏–±–∫–∞ –≤ –ø–æ–∑–∏—Ü–∏—è—Ö –ø–æ—Å–ª–µ —Ä–æ–∫–∏—Ä–æ–≤–∫–∏")

def test_en_passant_functionality():
    """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –≤–∑—è—Ç–∏—è –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ"""
    print("\n\n‚ôü –¢–ï–°–¢ –í–ó–Ø–¢–ò–Ø –ù–ê –ü–†–û–•–û–î–ï ‚ôü")
    print("=" * 30)
    
    engine = ChessEngineWrapper()
    
    # –£—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–∞ en passant
    engine.board_state = [
        ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
        ['p', 'p', 'p', 'p', '.', 'p', 'p', 'p'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', 'P', 'p', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['P', 'P', 'P', 'P', '.', 'P', 'P', 'P'],
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
    ]
    engine.current_turn = True  # –ë–µ–ª—ã–µ —Ö–æ–¥—è—Ç
    
    print("–ü–æ–∑–∏—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞ en passant:")
    engine.print_board()
    
    # –ë–µ–ª—ã–µ –¥–µ–ª–∞—é—Ç –¥–≤–æ–π–Ω–æ–π —Ö–æ–¥ –ø–µ—à–∫–æ–π f2-f4
    print("\n–ë–µ–ª—ã–µ: f2-f4 (–¥–≤–æ–π–Ω–æ–π —Ö–æ–¥ –ø–µ—à–∫–æ–π)")
    engine.make_move((6, 5), (4, 5))
    
    print("–ü–æ—Å–ª–µ –¥–≤–æ–π–Ω–æ–≥–æ —Ö–æ–¥–∞:")
    engine.print_board()
    
    # –ü—Ä–æ–≤–µ—Ä–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∑—è—Ç–∏—è –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ
    print("\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–∑—è—Ç–∏—è –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ exf3:")
    en_passant_valid = engine.is_valid_move((3, 4), (4, 5))  # e5 takes f4 en passant
    print("–í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ –≤–∞–ª–∏–¥–Ω–æ:", en_passant_valid)
    
    if en_passant_valid:
        print("\n–í—ã–ø–æ–ª–Ω—è–µ–º –≤–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ:")
        en_passant_success = engine.make_move((3, 4), (4, 5))
        print("–í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ —É—Å–ø–µ—à–Ω–æ:", en_passant_success)
        
        if en_passant_success:
            engine.print_board()
            print("‚úÖ –í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")
        else:
            print("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤–∑—è—Ç–∏—è –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ")
    else:
        print("‚ùå –í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ –Ω–µ –≤–∞–ª–∏–¥–Ω–æ")

def test_check_and_mate_detection():
    """–¢–µ—Å—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —à–∞—Ö–∞ –∏ –º–∞—Ç–∞"""
    print("\n\n‚ôî –¢–ï–°–¢ –û–ë–ù–ê–†–£–ñ–ï–ù–ò–Ø –®–ê–•–ê –ò –ú–ê–¢–ê ‚ôö")
    print("=" * 40)
    
    engine = ChessEngineWrapper()
    
    # –°–æ–∑–¥–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å —à–∞—Ö–æ–º (—Ñ–µ—Ä–∑—å –Ω–∞ h5, –∫–æ—Ä–æ–ª—å –Ω–∞ e1)
    engine.board_state = [
        ['r', 'n', 'b', '.', 'k', 'b', 'n', 'r'],
        ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', 'q'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['.', '.', '.', '.', '.', '.', '.', '.'],
        ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
        ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
    ]
    engine.current_turn = True  # –ë–µ–ª—ã–µ —Ö–æ–¥—è—Ç
    
    print("–ü–æ–∑–∏—Ü–∏—è —Å —à–∞—Ö–æ–º –∫–æ—Ä–æ–ª—é:")
    engine.print_board()
    
    # –ü—Ä–æ–≤–µ—Ä–∏–º —à–∞—Ö
    print("\n–ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞—Ö–∞:")
    is_white_check = engine.is_king_in_check(True)
    is_black_check = engine.is_king_in_check(False)
    print("–ë–µ–ª—ã–π –∫–æ—Ä–æ–ª—å –ø–æ–¥ —à–∞—Ö–æ–º:", is_white_check)
    print("–ß–µ—Ä–Ω—ã–π –∫–æ—Ä–æ–ª—å –ø–æ–¥ —à–∞—Ö–æ–º:", is_black_check)
    
    if is_white_check:
        print("‚úÖ –®–∞—Ö –±–µ–ª–æ–º—É –∫–æ—Ä–æ–ª—é –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!")
        
        # –ü—Ä–æ–≤–µ—Ä–∏–º –º–∞—Ç
        print("\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç–∞:")
        is_mate = engine.is_checkmate(True)
        print("–ë–µ–ª—ã–π –∫–æ—Ä–æ–ª—å –≤ –º–∞—Ç–µ:", is_mate)
        
        if is_mate:
            print("‚úÖ –ú–∞—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!")
        else:
            print("‚ÑπÔ∏è  –≠—Ç–æ —à–∞—Ö, –Ω–æ –Ω–µ –º–∞—Ç (–µ—Å—Ç—å —Å–ø–∞—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–æ–¥—ã)")
            
            # –ü–æ–∫–∞–∂–µ–º —Å–ø–∞—Å–∏—Ç–µ–ª—å–Ω—ã–µ —Ö–æ–¥—ã
            print("\n–ü–æ–∏—Å–∫ —Å–ø–∞—Å–∏—Ç–µ–ª—å–Ω—ã—Ö —Ö–æ–¥–æ–≤...")
            # –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± - –ø–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–æ—Ä–æ–ª—è
            king_moves = [(7, 4), (6, 3)], [(7, 4), (6, 4)], [(7, 4), (6, 5)]  # Kf1, Ke1, Kg1
            
            for from_pos, to_pos in king_moves:
                if engine.is_valid_move(from_pos, to_pos):
                    print(f"‚úÖ –°–ø–∞—Å–∏—Ç–µ–ª—å–Ω—ã–π —Ö–æ–¥: K{chr(97+from_pos[1])}{8-from_pos[0]}-{chr(97+to_pos[1])}{8-to_pos[0]}")

if __name__ == "__main__":
    test_engine_basics()
    test_castling_functionality()
    test_en_passant_functionality()
    test_check_and_mate_detection()
    print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!")
    print("\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
    print("-" * 20)
    print("‚úì –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å")
    print("‚úì –í–∞–ª–∏–¥–∞—Ü–∏—è —Ö–æ–¥–æ–≤")
    print("‚úì –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —à–∞—Ö–∞")
    print("‚úì –†–æ–∫–∏—Ä–æ–≤–∫–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)")
    print("‚úì –í–∑—è—Ç–∏–µ –Ω–∞ –ø—Ä–æ—Ö–æ–¥–µ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)")
    print("‚úì –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–∞—Ç–∞")