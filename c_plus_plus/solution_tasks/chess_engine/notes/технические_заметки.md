# Технические заметки по реализации шахматного движка

## Представление доски

### Координаты:

- Квадраты нумеруются от 0 до 63
- a1 = 0, h1 = 7, a8 = 56, h8 = 63
- Преобразование: square = rank * 8 + file

### Фигуры:

- EMPTY = 0 (пустая клетка)
- PAWN = 1, KNIGHT = 2, BISHOP = 3
- ROOK = 4, QUEEN = 5, KING = 6

### Цвета:

- WHITE = 0, BLACK = 1

## Генерация ходов

### Направления для фигур:

- **Ладья**: (0,1), (0,-1), (1,0), (-1,0)
- **Слон**: (1,1), (1,-1), (-1,1), (-1,-1)
- **Ферзь**: все 8 направлений
- **Конь**: 8 L-образных ходов

### Специальные случаи:

- Пешка: обычный ход, взятие, двойной ход с 2-й горизонтали
- Король: обычные ходы + рокировка
- Взятие на проходе: проверка предыдущего хода

## Алгоритм минимакс

### Псевдокод:

```
функция minimax(позиция, глубина, α, β, maximizingPlayer):
    если глубина = 0 или терминальная позиция:
        вернуть evaluate(позиция)
    
    если maximizingPlayer:
        значение := -∞
        для каждого хода в generateMoves(позиция):
            значение := max(значение, minimax(ход, глубина-1, α, β, FALSE))
            α := max(α, значение)
            если α ≥ β:
                прервать
        вернуть значение
    иначе:
        значение := +∞
        для каждого хода в generateMoves(позиция):
            значение := min(значение, minimax(ход, глубина-1, α, β, TRUE))
            β := min(β, значение)
            если α ≥ β:
                прервать
        вернуть значение
```

### Оптимизации:

- Упорядочивание ходов (MVV/LVA)
- Транспозиционные таблицы
- Null-move pruning
- Futility pruning

## Оценка позиции

### Компоненты оценки:

1. **Материальный баланс**: сумма значений фигур
2. **Позиционные таблицы**: бонусы за хорошие позиции
3. **Мобильность**: количество доступных ходов
4. **Безопасность короля**: защита короля
5. **Структура пешек**: избегать слабых пешек

### Значения фигур:

- Пешка: 100
- Конь: 300
- Слон: 300
- Ладья: 500
- Ферзь: 900
- Король: 10000 (бесконечность)

## Обработка специальных ходов

### Рокировка:

- Проверка: король и ладья не двигались
- Проверка: между ними нет фигур
- Проверка: король не находится под шахом
- Проверка: король не проходит через атакованные поля

### Взятие на проходе:

- Доступно только сразу после двойного хода пешки
- Записывается в enPassantSquare_
- Снимается на следующий ход

### Превращение пешки:

- При достижении 1-й/8-й горизонтали
- Выбор фигуры: ферзь, ладья, слон, конь

## Определение окончания партии

### Шах:

- Король находится под атакой
- Есть хотя бы один легальный ход

### Мат:

- Король под шахом
- Нет легальных ходов для спасения

### Пат:

- Король не под шахом
- Нет легальных ходов
- Ходит текущий игрок

### Ничья:

- Повторение позиции 3 раза
- Правило 50 ходов
- Недостаток материала

## Оптимизация производительности

### Профилирование:

- Основное время: генерация ходов и оценка позиции
- Кэширование оценок позиций
- Битборды вместо массивов (будущее улучшение)

### Эвристики:

- Первыми рассматривать взятия
- Первыми рассматривать ходы прошлого лучшего варианта
- Отсечение ходов, ведущих к очевидно плохим позициям

## Обработка ошибок

### Валидация входных данных:

- Проверка формата хода
- Проверка границ доски
- Проверка легальности хода

### Исключения:

- InvalidMoveException для некорректных ходов
- GameOverException при попытке хода после окончания игры

## Тестирование

### Единичные тесты:

- Все типы ходов каждой фигуры
- Специальные ходы
- Крайние случаи (края доски)

### Интеграционные тесты:

- Полные партии
- Игра против известных позиций
- Сравнение с другими движками

### Стресс-тестирование:

- Длинные партии
- Параллельные игры
- Пределы по времени и памяти