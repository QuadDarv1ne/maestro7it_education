class Solution {
public:
    int maxProfit(vector<int>& prices) {
        /**
         * Решение задачи "Лучшее время для покупки и продажи акций III"
         * 
         * Условие задачи:
         * Дан массив prices, где prices[i] - цена акции в i-й день.
         * Необходимо найти максимальную прибыль, которую можно получить,
         * совершив не более двух транзакций (покупка + продажа).
         * 
         * Ограничения:
         * - Нельзя совершать несколько транзакций одновременно
         * - Нельзя покупать, если уже есть акция
         * - Нельзя продавать, если нет акции
         * - Можно совершить 0, 1 или 2 транзакции
         * 
         * Детали реализации:
         * Используется подход динамического программирования с 4 состояниями.
         * Каждое состояние представляет максимальную прибыль в определенной
         * точке транзакции.
         */
        
        if (prices.size() < 2) {
            return 0; // Невозможно совершить транзакцию при менее чем 2 днях
        }
        
        // Состояния динамического программирования:
        int firstBuy = INT_MIN;   // Максимальная прибыль после первой покупки
        int firstSell = 0;        // Максимальная прибыль после первой продажи
        int secondBuy = INT_MIN;  // Максимальная прибыль после второй покупки
        int secondSell = 0;       // Максимальная прибыль после второй продажи
        
        for (int price : prices) {
            // Обновляем состояния для текущего дня
            
            // Для первой покупки: либо не покупаем, либо покупаем сегодня
            firstBuy = max(firstBuy, -price);
            
            // Для первой продажи: либо не продаем, либо продаем сегодня
            // (продажа возможна только если была покупка)
            firstSell = max(firstSell, firstBuy + price);
            
            // Для второй покупки: либо не покупаем, либо покупаем сегодня
            // (используем прибыль от первой продажи)
            secondBuy = max(secondBuy, firstSell - price);
            
            // Для второй продажи: либо не продаем, либо продаем сегодня
            // (продажа возможна только если была вторая покупка)
            secondSell = max(secondSell, secondBuy + price);
        }
        
        // Второй продажей будет максимальная прибыль от 0, 1 или 2 транзакций
        return secondSell;
    }
};