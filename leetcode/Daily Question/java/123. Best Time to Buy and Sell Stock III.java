class Solution {
    public int maxProfit(int[] prices) {
        /**
         * Решение задачи "Лучшее время для покупки и продажи акций III"
         * 
         * Задача:
         * Найти максимальную прибыль от не более чем двух транзакций
         * (каждая транзакция: покупка + продажа) при заданных ценах акций.
         * 
         * Ограничения:
         * 1. Нельзя держать более одной акции одновременно
         * 2. Нельзя совершать транзакции в один день (купить и продать в тот же день)
         * 3. Можно совершить 0, 1 или 2 полных транзакции
         * 
         * Пояснение решения:
         * Мы моделируем 4 состояния, которые представляют максимальную прибыль
         * на разных этапах транзакций. Это позволяет отслеживать лучшие варианты
         * для первой и второй транзакции одновременно.
         */
        
        // Обработка краевых случаев
        if (prices == null || prices.length <= 1) {
            return 0;
        }
        
        // Состояния:
        // hold1 - максимальная прибыль, если мы держим первую купленную акцию
        int hold1 = Integer.MIN_VALUE;
        // sold1 - максимальная прибыль после продажи первой акции
        int sold1 = 0;
        // hold2 - максимальная прибыль, если мы держим вторую купленную акцию
        int hold2 = Integer.MIN_VALUE;
        // sold2 - максимальная прибыль после продажи второй акции
        int sold2 = 0;
        
        for (int i = 0; i < prices.length; i++) {
            int price = prices[i];
            
            // Обновление в правильном порядке:
            // 1. Для первой покупки: либо остаемся с текущей покупкой, либо покупаем сегодня
            hold1 = Math.max(hold1, -price);
            
            // 2. Для первой продажи: либо остаемся без акции, либо продаем сегодня
            // (если купили по цене hold1)
            sold1 = Math.max(sold1, hold1 + price);
            
            // 3. Для второй покупки: либо остаемся со второй покупкой, либо покупаем сегодня
            // (используя прибыль от sold1)
            hold2 = Math.max(hold2, sold1 - price);
            
            // 4. Для второй продажи: либо остаемся без второй акции, либо продаем сегодня
            sold2 = Math.max(sold2, hold2 + price);
        }
        
        // Максимальная прибыль будет в состоянии sold2
        // Это покрывает случаи 0, 1 и 2 транзакций
        return sold2;
    }
}