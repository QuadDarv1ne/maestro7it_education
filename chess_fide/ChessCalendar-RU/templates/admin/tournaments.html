{% extends "admin/base.html" %}

{% block title %}Турниры - Админ панель - ChessCalendar-RU{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-trophy"></i> Управление турнирами</h4>
                    <div>
                        <a href="{{ url_for('admin.add_tournament') }}" class="btn btn-light">
                            <i class="bi bi-plus-circle"></i> Добавить турнир
                        </a>
                        <a href="{{ url_for('admin.import_tournaments') }}" class="btn btn-light ms-2">
                            <i class="bi bi-upload"></i> Импорт
                        </a>
                        <a href="{{ url_for('admin.export_tournaments') }}" class="btn btn-light ms-2">
                            <i class="bi bi-download"></i> Экспорт
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <!-- Bulk Actions -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-secondary" id="selectAllBtn">
                                    <i class="bi bi-check-all"></i> Выделить все
                                </button>
                                <button class="btn btn-outline-danger" id="bulkDeleteBtn" disabled>
                                    <i class="bi bi-trash"></i> Удалить выделенные
                                </button>
                                <select class="form-select" id="bulkStatusSelect" style="width: auto;">
                                    <option value="">Изменить статус</option>
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="Ongoing">Ongoing</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                                <button class="btn btn-outline-primary" id="bulkUpdateStatusBtn" disabled>
                                    <i class="bi bi-check"></i> Применить
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tournament Table -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="masterCheckbox"></th>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Даты</th>
                                    <th>Место</th>
                                    <th>Категория</th>
                                    <th>Статус</th>
                                    <th>Описание</th>
                                    <th>Призовой фонд</th>
                                    <th>Организатор</th>
                                    <th>FIDE ID</th>
                                    <th>Средняя оценка</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tournament in tournaments.items %}
                                <tr id="tournament-row-{{ tournament.id }}">
                                    <td><input type="checkbox" class="tournament-checkbox" value="{{ tournament.id }}"></td>
                                    <td>{{ tournament.id }}</td>
                                    <td>
                                        <a href="{{ url_for('main.tournament_detail', tournament_id=tournament.id) }}" target="_blank">
                                            {{ tournament.name[:50] }}{% if tournament.name|length > 50 %}...{% endif %}
                                        </a>
                                    </td>
                                    <td>
                                        {{ tournament.start_date.strftime('%d.%m.%Y') }}<br>
                                        <small class="text-muted">{{ tournament.end_date.strftime('%d.%m.%Y') }}</small>
                                    </td>
                                    <td>{{ tournament.location[:30] }}{% if tournament.location|length > 30 %}...{% endif %}</td>
                                    <td><span class="badge bg-info">{{ tournament.category }}</span></td>
                                    <td>
                                        <span class="badge {% if tournament.status == 'Completed' %}bg-success{% elif tournament.status == 'Ongoing' %}bg-warning{% elif tournament.status == 'Cancelled' %}bg-danger{% else %}bg-primary{% endif %}">
                                            {{ tournament.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if tournament.description %}
                                            <span class="text-muted small">{{ tournament.description[:50] }}{% if tournament.description|length > 50 %}...{% endif %}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if tournament.prize_fund %}
                                            <span class="text-success fw-bold">{{ tournament.prize_fund[:30] }}{% if tournament.prize_fund|length > 30 %}...{% endif %}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if tournament.organizer %}
                                            <span class="text-info">{{ tournament.organizer[:30] }}{% if tournament.organizer|length > 30 %}...{% endif %}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if tournament.fide_id %}
                                            <span class="text-primary">{{ tournament.fide_id }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if tournament.average_rating %}
                                            <div class="rating-display">
                                                <span class="rating-stars">
                                                    {% for i in range(5) %}
                                                        {% if i < (tournament.average_rating | int) %}
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        {% else %}
                                                            <i class="bi bi-star text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </span>
                                                <span class="rating-value">{{ tournament.average_rating }}</span>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('admin.edit_tournament', id=tournament.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('admin.delete_tournament', id=tournament.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Вы уверены, что хотите удалить турнир?')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if tournaments.pages > 1 %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if tournaments.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.tournaments', page=tournaments.prev_num) }}">Предыдущая</a>
                                </li>
                            {% endif %}

                            {% for page_num in tournaments.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != tournaments.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('admin.tournaments', page=page_num) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">…</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if tournaments.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.tournaments', page=tournaments.next_num) }}">Следующая</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Bulk selection functionality
const masterCheckbox = document.getElementById('masterCheckbox');
const checkboxes = document.querySelectorAll('.tournament-checkbox');
const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
const bulkUpdateStatusBtn = document.getElementById('bulkUpdateStatusBtn');
const bulkStatusSelect = document.getElementById('bulkStatusSelect');

masterCheckbox.addEventListener('change', function() {
    checkboxes.forEach(checkbox => {
        checkbox.checked = masterCheckbox.checked;
    });
    updateBulkButtons();
});

checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        updateBulkButtons();
        updateMasterCheckbox();
    });
});

function updateBulkButtons() {
    const checkedCount = document.querySelectorAll('.tournament-checkbox:checked').length;
    bulkDeleteBtn.disabled = checkedCount === 0;
    bulkUpdateStatusBtn.disabled = checkedCount === 0 || !bulkStatusSelect.value;
}

function updateMasterCheckbox() {
    const allChecked = checkboxes.length > 0 && [...checkboxes].every(cb => cb.checked);
    const someChecked = [...checkboxes].some(cb => cb.checked);
    masterCheckbox.checked = allChecked;
    masterCheckbox.indeterminate = someChecked && !allChecked;
}

document.getElementById('selectAllBtn').addEventListener('click', function() {
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    masterCheckbox.checked = true;
    updateBulkButtons();
});

bulkDeleteBtn.addEventListener('click', function() {
    const selectedIds = [...document.querySelectorAll('.tournament-checkbox:checked')].map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Выберите турниры для удаления');
        return;
    }
    
    if (!confirm(`Вы уверены, что хотите удалить ${selectedIds.length} турниров?`)) {
        return;
    }
    
    fetch('{{ url_for("admin.bulk_delete_tournaments") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({tournament_ids: selectedIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            selectedIds.forEach(id => {
                document.getElementById(`tournament-row-${id}`).remove();
            });
            alert(data.message);
            location.reload(); // Reload to update pagination
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при удалении');
    });
});

bulkStatusSelect.addEventListener('change', function() {
    bulkUpdateStatusBtn.disabled = !this.value || document.querySelectorAll('.tournament-checkbox:checked').length === 0;
});

bulkUpdateStatusBtn.addEventListener('click', function() {
    const selectedIds = [...document.querySelectorAll('.tournament-checkbox:checked')].map(cb => cb.value);
    const newStatus = bulkStatusSelect.value;
    
    if (selectedIds.length === 0) {
        alert('Выберите турниры для обновления статуса');
        return;
    }
    
    if (!newStatus) {
        alert('Выберите новый статус');
        return;
    }
    
    if (!confirm(`Вы уверены, что хотите изменить статус ${selectedIds.length} турниров на "${newStatus}"?`)) {
        return;
    }
    
    fetch('{{ url_for("admin.bulk_update_status") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({tournament_ids: selectedIds, status: newStatus})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            location.reload(); // Reload to see updated statuses
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при обновлении статуса');
    });
});
</script>
{% endblock %}