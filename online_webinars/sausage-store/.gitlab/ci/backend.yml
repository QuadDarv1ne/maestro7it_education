stages:
  - build
  - test
  - release
  - notify

variables:
  VERSION: 0.0.${CI_PIPELINE_ID}
  BACKEND_DIR: backend
  MAVEN_REPO_PATH: ${CI_PROJECT_DIR}/.m2/repository
  MAVEN_CLI_OPTS: "-Dmaven.repo.local=${MAVEN_REPO_PATH}"
  ARTIFACT_NAME: sausage-store-${VERSION}.jar

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
cache:
  key: ${CI_COMMIT_REF_SLUG}-backend
  paths:
    - ${MAVEN_REPO_PATH}

build-backend-code-job:
  stage: build
  image: maven:3.8-openjdk-16
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
      - .gitlab/ci/backend.yml
  before_script:
    - cd ${BACKEND_DIR}
  script:
    - echo "üî® –°–±–æ—Ä–∫–∞ backend –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    - mvn clean package -DskipTests ${MAVEN_CLI_OPTS}
    - echo "BUILD_VERSION=${CI_JOB_ID}" >> ${CI_PROJECT_DIR}/build.env
    - echo "BUILD_TIME=$(date -Iseconds)" >> ${CI_PROJECT_DIR}/build.env
    - echo "COMMIT_SHA=${CI_COMMIT_SHORT_SHA}" >> ${CI_PROJECT_DIR}/build.env
    - echo "JAR_FILE=$(ls target/*.jar | head -n1 | xargs basename)" >> ${CI_PROJECT_DIR}/build.env
  artifacts:
    paths:
      - ${BACKEND_DIR}/target/*.jar
    reports:
      dotenv: build.env
    expire_in: 1 week
  tags:
    - docker

semgrep-sast:
  stage: test
  image: returntocorp/semgrep:latest
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
      - .gitlab/ci/backend.yml
    refs:
      - main
      - master
      - dev
  variables:
    COMPILE: "false"
    SAST_JAVA_VERSION: "17"
    SEMGREP_RULES: >-
      p/security-audit
      p/java
      p/owasp-top-ten
  before_script:
    - cd ${BACKEND_DIR}
  script:
    - |
      echo "üîç –ó–∞–ø—É—Å–∫ SAST –∞–Ω–∞–ª–∏–∑–∞ —Å Semgrep..."
      semgrep scan --config=${SEMGREP_RULES} \
        --json --output=semgrep-report.json || true
      
      # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      if [ -f semgrep-report.json ]; then
        echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:"
        cat semgrep-report.json | jq '.results | length' || echo "–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω"
      fi
  artifacts:
    paths:
      - ${BACKEND_DIR}/semgrep-report.json
    expire_in: 1 week
    when: always
  needs:
    - job: build-backend-code-job
      artifacts: true
  allow_failure: true
  tags:
    - docker

sonarqube-backend-sast:
  stage: test
  image: maven:3.8-openjdk-16
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
      - .gitlab/ci/backend.yml
  before_script:
    - cd ${BACKEND_DIR}
  script:
    - |
      echo "üîç –ó–∞–ø—É—Å–∫ SonarQube –∞–Ω–∞–ª–∏–∑–∞..."
      mvn verify sonar:sonar ${MAVEN_CLI_OPTS} \
        -Dsonar.projectKey=${SONAR_PROJECT_KEY_BACK} \
        -Dsonar.host.url=${SONARQUBE_URL} \
        -Dsonar.login=${SONAR_LOGIN_BACK} \
        -Dsonar.projectName=${SONAR_PROJECT_NAME_BACK} \
        -Dsonar.projectVersion=${VERSION} \
        -Dsonar.qualitygate.wait=true
  needs:
    - job: build-backend-code-job
      artifacts: true
  allow_failure: true
  tags:
    - docker

upload-backend-release:
  stage: release
  image: maven:3.8-openjdk-16
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
      - .gitlab/ci/backend.yml
    refs:
      - main
      - master
      - dev
      - tags
  variables:
    FULL_URL: ${NEXUS_REPO_URL}/repository/${NEXUS_REPO_BACKEND_NAME}
  before_script:
    - cd ${BACKEND_DIR}
  script:
    - |
      echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ –≤ Nexus..."
      echo "Repository URL: ${FULL_URL}"
      echo "Version: ${VERSION}"
      
      # –û—á–∏—Å—Ç–∫–∞ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
      mvn clean package -DskipTests ${MAVEN_CLI_OPTS}
      
      # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Nexus
      echo "‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –≤ Nexus..."
      mvn deploy -DskipTests ${MAVEN_CLI_OPTS} \
        -s settings.xml \
        -Dversion.application=${VERSION} \
        -DaltDeploymentRepository=nexus::default::${FULL_URL}
      
      if [ $? -eq 0 ]; then
        echo "‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Nexus"
      else
        echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –≤ Nexus"
        exit 1
      fi
  needs:
    - job: build-backend-code-job
      artifacts: true
    - job: sonarqube-backend-sast
      artifacts: false
  artifacts:
    when: on_failure
    paths:
      - ${BACKEND_DIR}/target/*.jar
    expire_in: 1 hour
  tags:
    - docker

telegram-notification-backend:
  stage: notify
  image: alpine:latest
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
      - .gitlab/ci/backend.yml
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ pipeline
      if [ "${CI_JOB_STATUS}" = "success" ]; then
        STATUS_EMOJI="‚úÖ"
        STATUS_TEXT="—É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
      else
        STATUS_EMOJI="‚ùå"
        STATUS_TEXT="–∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
      fi
      
      # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      MESSAGE="
${STATUS_EMOJI} <b>Backend Sausage Store ${STATUS_TEXT}</b>

üë§ <b>–ê–≤—Ç–æ—Ä:</b> ${GITLAB_USER_NAME}
üì¶ <b>–í–µ—Ä—Å–∏—è:</b> ${VERSION}
üîñ <b>–ö–æ–º–º–∏—Ç:</b> <code>${CI_COMMIT_SHORT_SHA}</code>
üåø <b>–í–µ—Ç–∫–∞:</b> ${CI_COMMIT_REF_NAME}
‚è± <b>–í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏:</b> ${BUILD_TIME}
üìÑ <b>JAR —Ñ–∞–π–ª:</b> ${JAR_FILE}

üì• <a href=\"${CI_PROJECT_URL}/-/jobs/${BUILD_VERSION}/artifacts/download\">–°–∫–∞—á–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç</a>
üîó <a href=\"${CI_PIPELINE_URL}\">–û—Ç–∫—Ä—ã—Ç—å Pipeline</a>
"
      
      # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è JSON
      MESSAGE_ESCAPED=$(echo "$MESSAGE" | jq -Rs .)
      
      # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
      RESPONSE=$(curl -s -X POST \
        -H 'Content-Type: application/json' \
        -d "{
          \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
          \"text\": ${MESSAGE_ESCAPED},
          \"parse_mode\": \"HTML\",
          \"disable_web_page_preview\": true
        }" \
        "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage")
      
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
      if echo "$RESPONSE" | jq -e '.ok' > /dev/null; then
        echo "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
      else
        echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: $RESPONSE"
      fi
  needs:
    - job: build-backend-code-job
      artifacts: true
  when: always
  allow_failure: true
  tags:
    - docker