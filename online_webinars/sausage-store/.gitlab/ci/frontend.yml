stages:
  - build
  - test
  - release
  - notify

variables:
  VERSION: 0.0.${CI_PIPELINE_ID}
  MAVEN_REPO_PATH: ${CI_PROJECT_DIR}/.m2/repository
  FRONTEND_DIR: frontend
  ARTIFACT_NAME: sausage-store-${VERSION}.tar.gz

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
cache:
  key: ${CI_COMMIT_REF_SLUG}-frontend
  paths:
    - ${FRONTEND_DIR}/node_modules/

build-frontend-code-job:
  stage: build
  image: node:16-alpine
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
  before_script:
    - cd ${FRONTEND_DIR}
  script:
    - npm ci --prefer-offline --no-audit
    - npm run build
    - echo "BUILD_VERSION=${CI_JOB_ID}" >> ../build.env
    - echo "BUILD_TIME=$(date -Iseconds)" >> ../build.env
    - echo "COMMIT_SHA=${CI_COMMIT_SHORT_SHA}" >> ../build.env
  artifacts:
    paths:
      - ${FRONTEND_DIR}/dist/frontend
    reports:
      dotenv: build.env
    expire_in: 1 week
  tags:
    - docker

sonarqube-frontend-sast:
  stage: test
  image: sonarsource/sonar-scanner-cli:latest
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
  before_script:
    - cd ${FRONTEND_DIR}
  script:
    - |
      sonar-scanner \
        -Dsonar.projectKey=${SONAR_PROJECT_KEY_FRONT} \
        -Dsonar.sources=. \
        -Dsonar.host.url=${SONARQUBE_URL} \
        -Dsonar.login=${SONAR_LOGIN_FRONT} \
        -Dsonar.projectName=${SONAR_PROJECT_NAME_FRONT} \
        -Dsonar.projectVersion=${VERSION}
  needs:
    - job: build-frontend-code-job
      artifacts: true
  allow_failure: true
  tags:
    - docker

upload-frontend-release:
  stage: release
  image: alpine:latest
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
    refs:
      - main
      - master
      - tags
  before_script:
    - apk add --no-cache curl tar
  script:
    - cd ${FRONTEND_DIR}/dist
    - tar czvf ${ARTIFACT_NAME} frontend
    - |
      echo "–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ ${ARTIFACT_NAME} –≤ Nexus..."
      HTTP_CODE=$(curl -w "%{http_code}" -o /dev/null -s -u "${NEXUS_REPO_USER}:${NEXUS_REPO_PASS}" \
        --upload-file ${ARTIFACT_NAME} \
        ${NEXUS_REPO_URL}/${NEXUS_REPO_FRONTEND_NAME}/${VERSION}/${ARTIFACT_NAME})
      
      if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
        echo "‚úì –ê—Ä—Ç–µ—Ñ–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω (HTTP ${HTTP_CODE})"
      else
        echo "‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (HTTP ${HTTP_CODE})"
        exit 1
      fi
  needs:
    - job: build-frontend-code-job
      artifacts: true
    - job: sonarqube-frontend-sast
      artifacts: false
  tags:
    - docker

telegram-notification-frontend:
  stage: notify
  image: alpine:latest
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ pipeline
      if [ "$CI_JOB_STATUS" = "success" ]; then
        STATUS_EMOJI="‚úÖ"
        STATUS_TEXT="—É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω"
      else
        STATUS_EMOJI="‚ùå"
        STATUS_TEXT="—É–ø–∞–ª —Å –æ—à–∏–±–∫–æ–π"
      fi
      
      # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      MESSAGE="${STATUS_EMOJI} Frontend ${STATUS_TEXT}
      
      üë§ –ê–≤—Ç–æ—Ä: ${GITLAB_USER_NAME}
      üì¶ –í–µ—Ä—Å–∏—è: ${VERSION}
      üîñ –ö–æ–º–º–∏—Ç: ${CI_COMMIT_SHORT_SHA}
      üåø –í–µ—Ç–∫–∞: ${CI_COMMIT_REF_NAME}
      
      üì• –ê—Ä—Ç–µ—Ñ–∞–∫—Ç: ${CI_PROJECT_URL}/-/jobs/${BUILD_VERSION}/artifacts/download
      üîó Pipeline: ${CI_PIPELINE_URL}"
      
      # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è JSON
      MESSAGE_ESCAPED=$(echo "$MESSAGE" | jq -Rs .)
      
      # –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
      curl -X POST \
        -H 'Content-Type: application/json' \
        -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": ${MESSAGE_ESCAPED}, \"parse_mode\": \"HTML\"}" \
        "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
  needs:
    - job: build-frontend-code-job
      artifacts: true
  when: always
  allow_failure: true
  tags:
    - docker

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∂–æ–±–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
cleanup-old-artifacts:
  stage: notify
  image: alpine:latest
  only:
    refs:
      - schedules
  script:
    - |
      echo "–û—á–∏—Å—Ç–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π..."
      # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ Nexus
  when: manual
  tags:
    - docker