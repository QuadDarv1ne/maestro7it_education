# -*- coding: utf-8 -*-
"""
–ü–æ–ª–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤ Ozon —Å –ø–æ–º–æ—â—å—é DuckDB

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ.
"""

import os
import sys
from pathlib import Path

# –î–æ–±–∞–≤–∏—Ç—å –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from config import LOG_LEVEL
from utils import setup_logging, get_logger
from ozon_db_setup import populate_database
from analytics import OzonAnalytics
from data_validator import DataValidator
from performance_monitor import PerformanceMonitor
from backup_manager import BackupManager


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞."""
    # –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    setup_logging(LOG_LEVEL)
    logger = get_logger(__name__)
    
    print("üéØ –ü–û–õ–ù–ê–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ü–†–û–ï–ö–¢–ê –ê–ù–ê–õ–ò–ó–ê –¢–û–í–ê–†–û–í OZON")
    print("="*60)
    logger.info("–ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞")
    
    try:
        # 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        print("\n1. üóÑÔ∏è  –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•")
        print("-" * 40)
        populate_database()
        print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
        
        # –ñ–¥–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        import time
        time.sleep(2)
        
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–±–æ—Ä–∫—É –º—É—Å–æ—Ä–∞ –∏ –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        import gc
        gc.collect()
        
        # 2. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        print("\n2. ‚úÖ –ü–†–û–í–ï–†–ö–ê –ö–ê–ß–ï–°–¢–í–ê –î–ê–ù–ù–´–•")
        print("-" * 40)
        validator = DataValidator()
        report = validator.generate_data_quality_report()
        # –í—ã–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ —Å–≤–æ–¥–∫—É
        lines = report.split('\n')
        summary_started = False
        for line in lines:
            if '–°–í–û–î–ö–ê:' in line:
                summary_started = True
            if summary_started:
                print(line)
        print("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        
        # 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        print("\n3. ‚ö° –ú–û–ù–ò–¢–û–†–ò–ù–ì –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò")
        print("-" * 40)
        monitor = PerformanceMonitor()
        
        # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        queries = [
            ("SELECT COUNT(*) FROM ozon_products;", "–ü–æ–¥—Å—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤"),
            ("SELECT * FROM ozon_products ORDER BY price DESC LIMIT 5;", "–¢–æ–ø –¥–æ—Ä–æ–≥–∏—Ö"),
            ("SELECT brand, AVG(price) FROM ozon_products GROUP BY brand;", "–¶–µ–Ω—ã –ø–æ –±—Ä–µ–Ω–¥–∞–º")
        ]
        
        for query, desc in queries:
            print(f"  –¢–µ—Å—Ç: {desc}")
            monitor.measure_query_performance(query)
        
        print(monitor.get_performance_summary())
        print("‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω")
        
        # 4. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        print("\n4. üìä –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –ê–ù–ê–õ–ò–ó")
        print("-" * 40)
        analytics = OzonAnalytics()
        with analytics:
            # –ü–æ–ª—É—á–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
            top_products = analytics.get_top_products_by_price(limit=5)
            high_rated = analytics.get_products_by_rating(min_rating=4.5, limit=5)
            categories = analytics.get_category_statistics()
            
            print(f"  –¢–æ–ø-5 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Ü–µ–Ω–µ: {len(top_products)} –Ω–∞–π–¥–µ–Ω–æ")
            print(f"  –¢–æ–≤–∞—Ä—ã —Å –≤—ã—Å–æ–∫–∏–º —Ä–µ–π—Ç–∏–Ω–≥–æ–º: {len(high_rated)} –Ω–∞–π–¥–µ–Ω–æ")
            print(f"  –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: {len(categories)} –∫–∞—Ç–µ–≥–æ—Ä–∏–π")
            
            # –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            analytics.export_to_csv(top_products, "demo_top_products.csv")
            analytics.export_to_json(categories, "demo_categories.json")
            print("  ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã")
        
        # –Ø–≤–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞
        del analytics
        import gc
        gc.collect()
        import time
        time.sleep(1)
        
        print("‚úÖ –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")
        
        # 5. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        print("\n5. üíæ –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï")
        print("-" * 40)
        backup_manager = BackupManager()
        backup_path = backup_manager.create_backup("demo_backup.zip")
        print(f"  ‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: {backup_path}")
        
        # –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        backups = backup_manager.list_backups()
        print(f"  –í—Å–µ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π: {len(backups)}")
        
        print("‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        
        # 6. –°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º –æ–ø–µ—Ä–∞—Ü–∏—è–º
        print("\n6. üìã –ò–¢–û–ì–û–í–ê–Ø –°–í–û–î–ö–ê")
        print("-" * 40)
        print("‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:")
        print("  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
        print("  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö") 
        print("  - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")
        print("  - –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç")
        print("  - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö")
        print("  - –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ")
        
        print(f"\n‚ú® –ü–û–õ–ù–ê–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!")
        print("–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ.")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏: {e}")
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return 1
    
    return 0


if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)