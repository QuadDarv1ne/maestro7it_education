<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacman - Улучшенная консолидированная версия</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #121212, #1a1a2e);
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-attachment: fixed;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .header {
            text-align: center;
            animation: pulse 2s infinite;
        }

        .header h1 {
            font-size: 2rem;
            color: #FFD700;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(145deg, #2c3e50, #1a2530);
            color: white;
            border: 2px solid #3498db;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn:hover {
            background: linear-gradient(145deg, #3498db, #2980b9);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        #game-canvas {
            background: #000;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: all 0.2s ease;
        }
        
        .settings {
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 440px;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .settings label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 440px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 1.2rem;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-label {
            font-size: 0.9rem;
            color: #bbb;
        }

        .info-value {
            font-weight: bold;
            color: #FFD700;
            font-size: 1.4rem;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }

        .instructions {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            max-width: 440px;
            text-align: center;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .instructions p {
            margin: 5px 0;
            color: #bbb;
        }

        .key {
            display: inline-block;
            padding: 2px 8px;
            background: #2c3e50;
            border-radius: 4px;
            font-family: monospace;
            border: 1px solid #3498db;
        }

        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 100;
            border: 2px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        
        /* Animations */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes powerGlow {
            from { box-shadow: 0 0 5px #0000FF; }
            to { box-shadow: 0 0 20px #0000FF, 0 0 30px #0000FF; }
        }
        
        .power-mode {
            animation: powerGlow 0.5s infinite alternate;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Responsive design */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 1rem;
            }
            
            #game-canvas {
                width: 95vw;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>Pacman - Улучшенная консолидированная версия</h1>
            <div class="controls">
                <button id="start-btn" class="btn">Начать игру</button>
                <button id="pause-btn" class="btn">Пауза</button>
                <button id="reset-btn" class="btn">Сброс</button>
            </div>
        </div>
        
        <canvas id="game-canvas" width="440" height="520"></canvas>
        
        <div class="status-bar">
            <div class="info-item">
                <span class="info-label">Очки</span>
                <span id="score" class="info-value">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">Уровень</span>
                <span id="level" class="info-value">1</span>
            </div>
            <div class="info-item">
                <span class="info-label">Жизни</span>
                <span id="lives" class="info-value">❤️❤️❤️</span>
            </div>
        </div>
        
        <div class="instructions">
            <p>Управление: <span class="key">↑</span> <span class="key">↓</span> <span class="key">←</span> <span class="key">→</span> или <span class="key">W</span> <span class="key">A</span> <span class="key">S</span> <span class="key">D</span></p>
            <p>Цель: Соберите всю еду и избегайте привидений!</p>
            <p>Собирайте супер-еду для временного преимущества!</p>
        </div>
        
        <div class="settings">
            <label>
                <input type="checkbox" id="sound-toggle" checked> Звук
            </label>
            <label>
                <input type="checkbox" id="music-toggle" checked> Музыка
            </label>
        </div>
    </div>
    
    <div id="message" class="message">
        <h2 id="message-title">Игра окончена</h2>
        <p id="message-text">Ваш счет: 0</p>
        <button id="message-btn" class="btn">OK</button>
    </div>

    <script>
        // Генератор музыки Pacman
        class PacmanMusic {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.volume = 0.3;
            }
            
            init() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    return true;
                } catch (e) {
                    console.warn('Web Audio API не поддерживается в этом браузере');
                    return false;
                }
            }
            
            // Ноты классической темы Pacman
            getThemeNotes() {
                return [
                    // Первая фраза
                    { frequency: 261.63, duration: 0.2 }, // До 4 октавы
                    { frequency: 329.63, duration: 0.2 }, // Ми 4 октавы
                    { frequency: 392.00, duration: 0.2 }, // Соль 4 октавы
                    { frequency: 523.25, duration: 0.4 }, // До 5 октавы
                    { frequency: 392.00, duration: 0.2 }, // Соль 4 октавы
                    { frequency: 523.25, duration: 0.4 }, // До 5 октавы
                    
                    // Вторая фраза
                    { frequency: 261.63, duration: 0.2 }, // До 4 октавы
                    { frequency: 329.63, duration: 0.2 }, // Ми 4 октавы
                    { frequency: 392.00, duration: 0.2 }, // Соль 4 октавы
                    { frequency: 523.25, duration: 0.4 }, // До 5 октавы
                    { frequency: 392.00, duration: 0.2 }, // Соль 4 октавы
                    { frequency: 523.25, duration: 0.4 }, // До 5 октавы
                    
                    // Третья фраза
                    { frequency: 659.25, duration: 0.2 }, // Ми 5 октавы
                    { frequency: 587.33, duration: 0.2 }, // Ре 5 октавы
                    { frequency: 523.25, duration: 0.2 }, // До 5 октавы
                    { frequency: 392.00, duration: 0.4 }, // Соль 4 октавы
                    { frequency: 440.00, duration: 0.2 }, // Ля 4 октавы
                    { frequency: 392.00, duration: 0.4 }, // Соль 4 октавы
                ];
            }
            
            playNote(frequency, duration, startTime) {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.type = 'square';
                oscillator.frequency.value = frequency;
                
                // Установить огибающую громкости
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.setValueAtTime(this.volume, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
                
                return startTime + duration;
            }
            
            playTheme() {
                if (!this.audioContext || this.isPlaying) return;
                
                this.isPlaying = true;
                const notes = this.getThemeNotes();
                let startTime = this.audioContext.currentTime;
                
                // Воспроизвести каждую ноту по очереди
                notes.forEach((note, index) => {
                    startTime = this.playNote(note.frequency, note.duration, startTime + (index * 0.01));
                });
                
                // Запланировать повтор
                setTimeout(() => {
                    if (this.isPlaying) {
                        this.playTheme();
                    }
                }, notes.length * 200);
            }
            
            stop() {
                this.isPlaying = false;
            }
            
            playSound(frequency, duration) {
                if (!this.audioContext) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.type = 'square';
                oscillator.frequency.value = frequency;
                
                // Установить огибающую громкости
                const startTime = this.audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.setValueAtTime(this.volume, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            }
        }

        class PacmanGame {
            constructor() {
                // Инициализация холста
                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.cellSize = 22;
                
                // Игровые параметры
                this.isRunning = false;
                this.animationFrameId = null;
                this.lastTimestamp = 0;
                this.updateInterval = 150; // Интервал обновления в миллисекундах (замедляет игру)
                this.lastUpdate = 0;
                
                // Игровые объекты
                this.pacman = {
                    x: 10,
                    y: 15,
                    direction: 'right',
                    nextDirection: null,
                    mouthAngle: 0,
                    mouthOpening: 0.1,
                    powerMode: false,
                    powerModeTimer: 0
                };
                
                this.ghosts = [
                    { x: 10, y: 8, direction: 'left', color: 'red', speed: 0.8, name: 'Blinky' },
                    { x: 9, y: 9, direction: 'up', color: 'pink', speed: 0.7, name: 'Pinky' },
                    { x: 11, y: 9, direction: 'down', color: 'cyan', speed: 0.9, name: 'Inky' },
                    { x: 10, y: 10, direction: 'right', color: 'orange', speed: 0.6, name: 'Clyde' }
                ];
                
                // Игровое состояние
                this.score = 0;
                this.level = 1;
                this.lives = 3;
                
                // Настройки
                this.soundEnabled = true;
                this.musicEnabled = true;
                
                // Система комбо
                this.consecutiveEats = 0;
                this.lastEatTime = 0;
                
                // Рекорды
                this.highScore = localStorage.getItem('pacmanHighScore') || 0;
                
                // Сложность игры
                this.difficulty = 1;
                
                // Фрукты
                this.fruits = [];
                this.fruitSpawnTimer = 0;
                this.fruitTypes = [
                    { name: 'Вишня', points: 100, color: '#FF0000' },
                    { name: 'Апельсин', points: 300, color: '#FFA500' },
                    { name: 'Яблоко', points: 500, color: '#00FF00' },
                    { name: 'Банан', points: 700, color: '#FFFF00' },
                    { name: 'Клубника', points: 1000, color: '#FF00FF' }
                ];
                
                // Карта уровня (1 - путь, 0 - стена, 2 - еда, 3 - супер-еда)
                this.map = [
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0],
                    [0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0],
                    [0,2,0,2,2,2,0,2,2,2,2,2,2,0,2,2,2,0,2,0],
                    [0,3,0,2,0,0,0,2,0,0,0,0,2,0,0,0,2,0,3,0],
                    [0,2,0,2,0,2,2,2,0,2,2,0,2,2,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,0,0,2,2,0,0,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,2,2,2,2,2,2,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,2,0,0,0,0,2,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,2,0,2,2,0,2,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,2,0,2,2,0,2,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,2,0,0,0,0,2,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,2,2,2,2,2,2,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,0,0,0,2,2,0,0,0,2,0,2,0,2,0],
                    [0,2,0,2,0,2,2,2,0,2,2,0,2,2,2,0,2,0,2,0],
                    [0,3,0,2,0,0,0,2,0,0,0,0,2,0,0,0,2,0,3,0],
                    [0,2,0,2,2,2,0,2,2,2,2,2,2,0,2,2,2,0,2,0],
                    [0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0],
                    [0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                ];
                
                // Подсчет еды
                this.foodCount = 0;
                this.totalFood = 0;
                this.countFood();
                
                // Инициализация звуков
                this.music = new PacmanMusic();
                this.music.init();
                
                // Звуки эффектов
                this.sounds = {
                    eat: { frequency: 440, duration: 0.1 },
                    powerUp: { frequency: 523.25, duration: 0.3 },
                    ghostEat: { frequency: 659.25, duration: 0.3 },
                    death: { frequency: 220, duration: 0.5 }
                };
                
                // Система уровней
                this.levelMaps = [
                    // Уровень 1 - оригинальная карта
                    [
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                        [0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0],
                        [0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0],
                        [0,2,0,2,2,2,0,2,2,2,2,2,2,0,2,2,2,0,2,0],
                        [0,3,0,2,0,0,0,2,0,0,0,0,2,0,0,0,2,0,3,0],
                        [0,2,0,2,0,2,2,2,0,2,2,0,2,2,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,0,0,2,2,0,0,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,2,2,2,2,2,2,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,2,0,0,0,0,2,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,2,0,2,2,0,2,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,2,0,2,2,0,2,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,2,0,0,0,0,2,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,2,2,2,2,2,2,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,0,0,0,2,2,0,0,0,2,0,2,0,2,0],
                        [0,2,0,2,0,2,2,2,0,2,2,0,2,2,2,0,2,0,2,0],
                        [0,3,0,2,0,0,0,2,0,0,0,0,2,0,0,0,2,0,3,0],
                        [0,2,0,2,2,2,0,2,2,2,2,2,2,0,2,2,2,0,2,0],
                        [0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0],
                        [0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0],
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                    ],
                    // Уровень 2 - более сложная карта
                    [
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                        [0,2,2,0,2,2,0,2,2,2,2,2,2,0,2,2,0,2,2,0],
                        [0,2,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,2,0],
                        [0,2,0,2,2,0,2,2,0,2,2,0,2,2,0,2,2,0,2,0],
                        [0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0],
                        [0,2,0,2,0,2,2,2,0,2,2,0,2,2,2,0,2,0,2,0],
                        [0,2,0,0,0,2,0,0,0,2,2,0,0,0,2,0,0,0,2,0],
                        [0,2,2,0,0,2,0,2,2,2,2,2,2,0,2,0,0,2,2,0],
                        [0,0,0,0,2,0,0,2,0,0,0,0,2,0,0,2,0,0,0,0],
                        [0,2,2,0,2,0,0,2,0,2,2,0,2,0,0,2,0,2,2,0],
                        [0,0,0,0,2,0,0,2,0,2,2,0,2,0,0,2,0,0,0,0],
                        [0,2,2,0,0,2,0,0,0,0,0,0,0,0,2,0,0,2,2,0],
                        [0,2,0,0,0,2,0,2,2,2,2,2,2,0,2,0,0,0,2,0],
                        [0,2,0,2,0,2,0,0,0,2,2,0,0,0,2,0,2,0,2,0],
                        [0,0,0,2,0,2,2,2,0,2,2,0,2,2,2,0,2,0,0,0],
                        [0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0],
                        [0,2,0,2,2,0,2,2,0,2,2,0,2,2,0,2,2,0,2,0],
                        [0,2,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,2,0],
                        [0,2,2,0,2,2,0,2,2,2,2,2,2,0,2,2,0,2,2,0],
                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                    ]
                ];
                
                // Инициализация событий
                this.setupEventListeners();
                
                // Инициализация настроек
                this.initSettings();
                
                // Первичная отрисовка
                this.draw();
            }
            
            initSettings() {
                const soundToggle = document.getElementById('sound-toggle');
                const musicToggle = document.getElementById('music-toggle');
                
                if (soundToggle) {
                    soundToggle.addEventListener('change', (e) => {
                        this.soundEnabled = e.target.checked;
                    });
                }
                
                if (musicToggle) {
                    musicToggle.addEventListener('change', (e) => {
                        this.musicEnabled = e.target.checked;
                        if (!this.musicEnabled) {
                            this.music.stop();
                        } else if (this.isRunning) {
                            this.music.playTheme();
                        }
                    });
                }
            }
            
            setupEventListeners() {
                // Кнопки управления
                document.getElementById('start-btn').addEventListener('click', () => {
                    this.start();
                });
                
                document.getElementById('pause-btn').addEventListener('click', () => {
                    this.pause();
                });
                
                document.getElementById('reset-btn').addEventListener('click', () => {
                    this.reset();
                });
                
                document.getElementById('message-btn').addEventListener('click', () => {
                    this.hideMessage();
                });
                
                // Управление клавишами
                document.addEventListener('keydown', (e) => {
                    this.handleKey(e);
                });
            }
            
            handleKey(e) {
                // Всегда разрешаем управление, даже если игра на паузе
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        this.pacman.nextDirection = 'up';
                        e.preventDefault();
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        this.pacman.nextDirection = 'down';
                        e.preventDefault();
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        this.pacman.nextDirection = 'left';
                        e.preventDefault();
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        this.pacman.nextDirection = 'right';
                        e.preventDefault();
                        break;
                }
            }
            
            countFood() {
                this.totalFood = 0;
                for (let y = 0; y < this.map.length; y++) {
                    for (let x = 0; x < this.map[y].length; x++) {
                        if (this.map[y][x] === 2 || this.map[y][x] === 3) {
                            this.totalFood++;
                        }
                    }
                }
            }
            
            start() {
                if (!this.isRunning) {
                    this.isRunning = true;
                    this.lastTimestamp = performance.now();
                    this.lastUpdate = performance.now();
                    this.gameLoop();
                    document.getElementById('start-btn').textContent = "Продолжить";
                    if (this.musicEnabled) {
                        this.music.playTheme();
                    }
                }
            }
            
            pause() {
                this.isRunning = false;
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                    this.animationFrameId = null;
                }
                this.music.stop();
            }
            
            loadLevelMap() {
                // Загружаем карту текущего уровня
                if (this.level <= this.levelMaps.length) {
                    this.map = JSON.parse(JSON.stringify(this.levelMaps[this.level - 1]));
                } else {
                    // Если уровень выше, чем у нас есть карты, используем первую карту
                    this.map = JSON.parse(JSON.stringify(this.levelMaps[0]));
                }
                this.countFood();
            }
            
            reset() {
                this.pause();
                this.pacman = {
                    x: 10,
                    y: 15,
                    direction: 'right',
                    nextDirection: null,
                    mouthAngle: 0,
                    mouthOpening: 0.1,
                    powerMode: false,
                    powerModeTimer: 0
                };
                
                // Увеличиваем скорость привидений с каждым уровнем
                const baseSpeeds = [0.8, 0.7, 0.9, 0.6];
                const speedMultiplier = 1 + (this.difficulty - 1) * 0.1; // Увеличиваем скорость на 10% за уровень
                
                this.ghosts = [
                    { x: 10, y: 8, direction: 'left', color: 'red', speed: baseSpeeds[0] * speedMultiplier, name: 'Blinky' },
                    { x: 9, y: 9, direction: 'up', color: 'pink', speed: baseSpeeds[1] * speedMultiplier, name: 'Pinky' },
                    { x: 11, y: 9, direction: 'down', color: 'cyan', speed: baseSpeeds[2] * speedMultiplier, name: 'Inky' },
                    { x: 10, y: 10, direction: 'right', color: 'orange', speed: baseSpeeds[3] * speedMultiplier, name: 'Clyde' }
                ];
                
                this.score = 0;
                this.level = 1;
                this.lives = 3;
                
                // Загружаем карту текущего уровня
                this.loadLevelMap();
                
                this.countFood();
                this.updateUI();
                this.draw();
                document.getElementById('start-btn').textContent = "Начать игру";
            }
            
            gameLoop(timestamp) {
                if (!this.isRunning) return;
                
                // Вычисляем deltaTime для плавного движения
                const deltaTime = timestamp - this.lastTimestamp;
                this.lastTimestamp = timestamp;
                
                // Обновляем игру с заданным интервалом
                if (timestamp - this.lastUpdate >= this.updateInterval) {
                    this.update(deltaTime);
                    this.lastUpdate = timestamp;
                }
                
                // Отрисовываем
                this.draw();
                
                // Продолжаем цикл
                this.animationFrameId = requestAnimationFrame((timestamp) => this.gameLoop(timestamp));
            }
            
            update(deltaTime) {
                // Обновляем движение Пакмана
                this.movePacman();
                
                // Обновляем движение привидений
                this.moveGhosts();
                
                // Проверяем столкновения
                this.checkCollisions();
                
                // Анимируем рот Пакмана
                this.animateMouth();
                
                // Update power mode timer
                if (this.pacman.powerMode) {
                    this.pacman.powerModeTimer -= deltaTime;
                    if (this.pacman.powerModeTimer <= 0) {
                        this.pacman.powerMode = false;
                        this.pacman.powerModeTimer = 0;
                        this.canvas.classList.remove('power-mode');
                    }
                }
                
                // Обновляем фрукты
                this.updateFruits(deltaTime);
            }
            
            movePacman() {
                // Применяем следующее направление, если возможно
                if (this.pacman.nextDirection) {
                    const nextPos = this.getNextPosition(this.pacman.x, this.pacman.y, this.pacman.nextDirection);
                    if (this.isValidMove(nextPos.x, nextPos.y)) {
                        this.pacman.direction = this.pacman.nextDirection;
                        this.pacman.nextDirection = null;
                    }
                }
                
                // Двигаемся в текущем направлении
                const nextPos = this.getNextPosition(this.pacman.x, this.pacman.y, this.pacman.direction);
                if (this.isValidMove(nextPos.x, nextPos.y)) {
                    this.pacman.x = nextPos.x;
                    this.pacman.y = nextPos.y;
                    
                    // Проверяем, есть ли еда в новой позиции
                    const cell = this.map[this.pacman.y][this.pacman.x];
                    if (cell === 2) { // Обычная еда
                        this.map[this.pacman.y][this.pacman.x] = 1; // Очищаем клетку
                        this.foodCount++;
                        
                        // Система комбо
                        const currentTime = Date.now();
                        if (currentTime - this.lastEatTime < 2000) { // 2 секунды для сохранения комбо
                            this.consecutiveEats++;
                            // Бонус за комбо: 10 базовых очков + 5 за каждый уровень комбо
                            const comboBonus = 10 + (this.consecutiveEats * 5);
                            this.score += comboBonus;
                        } else {
                            this.consecutiveEats = 0;
                            this.score += 10;
                        }
                        this.lastEatTime = currentTime;
                        
                        if (this.soundEnabled) this.playSound('eat');
                        this.checkLevelComplete();
                    } else if (cell === 3) { // Супер-еда
                        this.map[this.pacman.y][this.pacman.x] = 1; // Очищаем клетку
                        this.foodCount++;
                        this.score += 50;
                        this.pacman.powerMode = true;
                        this.pacman.powerModeTimer = 5000; // 5 секунд
                        this.canvas.classList.add('power-mode');
                        if (this.soundEnabled) this.playSound('powerUp');
                        this.checkLevelComplete();
                    }
                }
            }
            
            moveGhosts() {
                this.ghosts.forEach(ghost => {
                    // Простая логика движения привидений - случайное направление
                    const directions = ['up', 'down', 'left', 'right'];
                    const oppositeDirection = {
                        'up': 'down',
                        'down': 'up',
                        'left': 'right',
                        'right': 'left'
                    };
                    
                    // Получаем возможные направления (не включая обратное)
                    const possibleDirections = directions.filter(dir => 
                        dir !== oppositeDirection[ghost.direction] && 
                        this.isValidMove(...Object.values(this.getNextPosition(ghost.x, ghost.y, dir)))
                    );
                    
                    // Если есть возможные направления, выбираем случайное
                    if (possibleDirections.length > 0) {
                        // С небольшой вероятностью меняем направление
                        if (Math.random() < 0.1) {
                            ghost.direction = possibleDirections[Math.floor(Math.random() * possibleDirections.length)];
                        }
                    } else {
                        // Если нет возможных направлений, пытаемся изменить направление
                        if (Math.random() < 0.3) {
                            ghost.direction = directions[Math.floor(Math.random() * directions.length)];
                        }
                    }
                    
                    // Двигаемся в текущем направлении
                    const nextPos = this.getNextPosition(ghost.x, ghost.y, ghost.direction);
                    if (this.isValidMove(nextPos.x, nextPos.y)) {
                        ghost.x = nextPos.x;
                        ghost.y = nextPos.y;
                    }
                });
            }
            
            getNextPosition(x, y, direction) {
                let newX = x;
                let newY = y;
                
                switch(direction) {
                    case 'up':
                        newY--;
                        break;
                    case 'down':
                        newY++;
                        break;
                    case 'left':
                        newX--;
                        break;
                    case 'right':
                        newX++;
                        break;
                }
                
                // Туннель (переход с одной стороны на другую)
                if (newX < 0) newX = this.map[0].length - 1;
                if (newX >= this.map[0].length) newX = 0;
                
                return { x: newX, y: newY };
            }
            
            isValidMove(x, y) {
                // Проверяем, что координаты находятся в пределах карты
                if (y < 0 || y >= this.map.length || x < 0 || x >= this.map[0].length) {
                    return false;
                }
                
                // Проверяем, что это не стена
                return this.map[y][x] !== 0;
            }
            
            checkCollisions() {
                // Проверяем столкновения с привидениями
                for (const ghost of this.ghosts) {
                    if (Math.floor(this.pacman.x) === Math.floor(ghost.x) && 
                        Math.floor(this.pacman.y) === Math.floor(ghost.y)) {
                        
                        if (this.pacman.powerMode) {
                            // Пакман съедает привидение
                            this.score += 200;
                            // Возвращаем привидение на начальную позицию
                            ghost.x = 10;
                            ghost.y = 8;
                            this.updateUI();
                            if (this.soundEnabled) this.playSound('ghostEat');
                        } else {
                            // Привидение съедает Пакмана
                            this.lives--;
                            this.updateUI();
                            
                            if (this.lives <= 0) {
                                if (this.soundEnabled) this.playSound('death');
                                this.gameOver();
                            } else {
                                if (this.soundEnabled) this.playSound('death');
                                // Возвращаем Пакмана и привидений на начальные позиции
                                this.pacman.x = 10;
                                this.pacman.y = 15;
                                this.ghosts[0].x = 10;
                                this.ghosts[0].y = 8;
                                this.ghosts[1].x = 9;
                                this.ghosts[1].y = 9;
                                this.ghosts[2].x = 11;
                                this.ghosts[2].y = 9;
                                this.ghosts[3].x = 10;
                                this.ghosts[3].y = 10;
                            }
                        }
                    }
                }
            }
            
            checkLevelComplete() {
                if (this.foodCount >= this.totalFood) {
                    // Уровень пройден
                    this.level++;
                    this.score += 1000;
                    this.difficulty = Math.min(this.level, 5); // Максимум 5 уровней сложности
                    this.reset();
                    this.showMessage("Уровень пройден!", `Ваш счет: ${this.score}`);
                    // Загружаем новую карту для следующего уровня
                    this.loadLevelMap();
                }
                this.updateUI();
            }
            
            gameOver() {
                this.pause();
                
                // Проверяем и обновляем рекорд
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('pacmanHighScore', this.highScore);
                    this.showMessage("Новый рекорд!", `Ваш счет: ${this.score}\nРекорд: ${this.highScore}`);
                } else {
                    this.showMessage("Игра окончена", `Ваш счет: ${this.score}\nРекорд: ${this.highScore}`);
                }
            }
            
            showMessage(title, text) {
                document.getElementById('message-title').textContent = title;
                document.getElementById('message-text').textContent = text;
                document.getElementById('message').style.display = 'block';
            }
            
            hideMessage() {
                document.getElementById('message').style.display = 'none';
            }
            
            playSound(soundName) {
                if (!this.soundEnabled) return;
                
                const sound = this.sounds[soundName];
                if (sound) {
                    this.music.playSound(sound.frequency, sound.duration);
                }
            }
            
            spawnFruit() {
                // Спауним фрукт с определенной вероятностью
                if (Math.random() < 0.001 * this.difficulty && this.fruits.length < 2) {
                    const fruitType = this.fruitTypes[Math.floor(Math.random() * this.fruitTypes.length)];
                    
                    // Находим случайную позицию на карте, которая не является стеной
                    let x, y;
                    do {
                        x = Math.floor(Math.random() * this.map[0].length);
                        y = Math.floor(Math.random() * this.map.length);
                    } while (this.map[y][x] !== 1); // Только на путях
                    
                    this.fruits.push({
                        x: x,
                        y: y,
                        type: fruitType,
                        lifetime: 10000 // 10 секунд
                    });
                }
            }
            
            updateFruits(deltaTime) {
                this.fruitSpawnTimer += deltaTime;
                
                // Спауним фрукты
                if (this.fruitSpawnTimer > 2000) { // Проверяем каждые 2 секунды
                    this.spawnFruit();
                    this.fruitSpawnTimer = 0;
                }
                
                // Обновляем время жизни фруктов
                for (let i = this.fruits.length - 1; i >= 0; i--) {
                    this.fruits[i].lifetime -= deltaTime;
                    if (this.fruits[i].lifetime <= 0) {
                        this.fruits.splice(i, 1);
                    }
                }
                
                // Проверяем сбор фруктов
                this.checkFruitCollection();
            }
            
            checkFruitCollection() {
                for (let i = this.fruits.length - 1; i >= 0; i--) {
                    const fruit = this.fruits[i];
                    if (Math.floor(this.pacman.x) === fruit.x && Math.floor(this.pacman.y) === fruit.y) {
                        this.score += fruit.type.points;
                        this.fruits.splice(i, 1);
                        if (this.soundEnabled) this.playSound('eat');
                        this.updateUI();
                    }
                }
            }
            
            animateMouth() {
                // Анимируем рот Пакмана
                this.pacman.mouthAngle += this.pacman.mouthOpening;
                if (this.pacman.mouthAngle <= 0 || this.pacman.mouthAngle >= 0.5) {
                    this.pacman.mouthOpening *= -1;
                }
            }
            
            updateUI() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('level').textContent = this.level;
                document.getElementById('lives').textContent = '❤️'.repeat(this.lives);
            }
            
            draw() {
                // Очищаем холст
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Рисуем карту
                for (let y = 0; y < this.map.length; y++) {
                    for (let x = 0; x < this.map[y].length; x++) {
                        const cell = this.map[y][x];
                        const pixelX = x * this.cellSize;
                        const pixelY = y * this.cellSize;
                        
                        switch(cell) {
                            case 0: // Стена
                                this.ctx.fillStyle = '#2233AA';
                                this.ctx.fillRect(pixelX, pixelY, this.cellSize, this.cellSize);
                                break;
                            case 1: // Путь
                                this.ctx.fillStyle = '#000';
                                this.ctx.fillRect(pixelX, pixelY, this.cellSize, this.cellSize);
                                break;
                            case 2: // Еда
                                this.ctx.fillStyle = '#FFD700';
                                this.ctx.beginPath();
                                this.ctx.arc(
                                    pixelX + this.cellSize/2,
                                    pixelY + this.cellSize/2,
                                    this.cellSize/8,
                                    0,
                                    Math.PI * 2
                                );
                                this.ctx.fill();
                                break;
                            case 3: // Супер-еда
                                this.ctx.fillStyle = '#FFFFFF';
                                this.ctx.beginPath();
                                this.ctx.arc(
                                    pixelX + this.cellSize/2,
                                    pixelY + this.cellSize/2,
                                    this.cellSize/4,
                                    0,
                                    Math.PI * 2
                                );
                                this.ctx.fill();
                                break;
                        }
                    }
                }
                
                // Рисуем фрукты
                this.fruits.forEach(fruit => {
                    this.ctx.fillStyle = fruit.type.color;
                    this.ctx.beginPath();
                    this.ctx.arc(
                        fruit.x * this.cellSize + this.cellSize/2,
                        fruit.y * this.cellSize + this.cellSize/2,
                        this.cellSize/3,
                        0,
                        Math.PI * 2
                    );
                    this.ctx.fill();
                    
                    // Рисуем стебель
                    this.ctx.fillStyle = '#00FF00';
                    this.ctx.fillRect(
                        fruit.x * this.cellSize + this.cellSize/2 - 1,
                        fruit.y * this.cellSize + this.cellSize/2 - this.cellSize/2,
                        2,
                        this.cellSize/3
                    );
                });
                
                // Рисуем Пакмана
                this.ctx.fillStyle = '#FFD700';
                this.ctx.beginPath();
                
                let startAngle, endAngle;
                switch(this.pacman.direction) {
                    case 'right':
                        startAngle = this.pacman.mouthAngle * Math.PI;
                        endAngle = (2 - this.pacman.mouthAngle) * Math.PI;
                        break;
                    case 'down':
                        startAngle = (0.5 + this.pacman.mouthAngle) * Math.PI;
                        endAngle = (1.5 - this.pacman.mouthAngle) * Math.PI;
                        break;
                    case 'left':
                        startAngle = (1 + this.pacman.mouthAngle) * Math.PI;
                        endAngle = (2 + this.pacman.mouthAngle) * Math.PI;
                        break;
                    case 'up':
                        startAngle = (1.5 + this.pacman.mouthAngle) * Math.PI;
                        endAngle = (2.5 - this.pacman.mouthAngle) * Math.PI;
                        break;
                }
                
                this.ctx.arc(
                    this.pacman.x * this.cellSize + this.cellSize/2,
                    this.pacman.y * this.cellSize + this.cellSize/2,
                    this.cellSize/2 - 1,
                    startAngle,
                    endAngle
                );
                this.ctx.lineTo(
                    this.pacman.x * this.cellSize + this.cellSize/2,
                    this.pacman.y * this.cellSize + this.cellSize/2
                );
                this.ctx.fill();
                
                // Рисуем привидений
                this.ghosts.forEach(ghost => {
                    // Цвет привидения
                    if (this.pacman.powerMode) {
                        this.ctx.fillStyle = '#0000FF'; // Синий в режиме силы
                    } else {
                        this.ctx.fillStyle = ghost.color;
                    }
                    
                    // Тело привидения
                    this.ctx.beginPath();
                    this.ctx.arc(
                        ghost.x * this.cellSize + this.cellSize/2,
                        ghost.y * this.cellSize + this.cellSize/2 - 2,
                        this.cellSize/2 - 1,
                        Math.PI,
                        0,
                        false
                    );
                    this.ctx.lineTo(
                        ghost.x * this.cellSize + this.cellSize,
                        ghost.y * this.cellSize + this.cellSize/2 + 4
                    );
                    
                    // "Волны" внизу
                    for (let i = 0; i < 3; i++) {
                        this.ctx.lineTo(
                            ghost.x * this.cellSize + this.cellSize - i * (this.cellSize/3),
                            ghost.y * this.cellSize + this.cellSize/2 + (i % 2 === 0 ? 8 : 4)
                        );
                    }
                    
                    this.ctx.lineTo(
                        ghost.x * this.cellSize,
                        ghost.y * this.cellSize + this.cellSize/2 + 4
                    );
                    this.ctx.closePath();
                    this.ctx.fill();
                    
                    // Глаза привидения
                    this.ctx.fillStyle = 'white';
                    this.ctx.beginPath();
                    this.ctx.arc(
                        ghost.x * this.cellSize + this.cellSize/3,
                        ghost.y * this.cellSize + this.cellSize/2 - 2,
                        this.cellSize/6,
                        0,
                        Math.PI * 2
                    );
                    this.ctx.arc(
                        ghost.x * this.cellSize + 2 * this.cellSize/3,
                        ghost.y * this.cellSize + this.cellSize/2 - 2,
                        this.cellSize/6,
                        0,
                        Math.PI * 2
                    );
                    this.ctx.fill();
                    
                    // Зрачки
                    this.ctx.fillStyle = 'black';
                    let pupilOffsetX = 0, pupilOffsetY = 0;
                    switch(ghost.direction) {
                        case 'left': pupilOffsetX = -1; break;
                        case 'right': pupilOffsetX = 1; break;
                        case 'up': pupilOffsetY = -1; break;
                        case 'down': pupilOffsetY = 1; break;
                    }
                    
                    this.ctx.beginPath();
                    this.ctx.arc(
                        ghost.x * this.cellSize + this.cellSize/3 + pupilOffsetX,
                        ghost.y * this.cellSize + this.cellSize/2 - 2 + pupilOffsetY,
                        this.cellSize/12,
                        0,
                        Math.PI * 2
                    );
                    this.ctx.arc(
                        ghost.x * this.cellSize + 2 * this.cellSize/3 + pupilOffsetX,
                        ghost.y * this.cellSize + this.cellSize/2 - 2 + pupilOffsetY,
                        this.cellSize/12,
                        0,
                        Math.PI * 2
                    );
                    this.ctx.fill();
                });
            }
        }

        // Инициализация игры при загрузке страницы
        window.addEventListener('DOMContentLoaded', () => {
            const game = new PacmanGame();
            window.pacmanGame = game; // Делаем игру доступной глобально для отладки
        });
    </script>
</body>
</html>