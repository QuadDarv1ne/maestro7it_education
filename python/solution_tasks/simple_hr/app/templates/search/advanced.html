{% extends "base.html" %}

{% block title %}Расширенный поиск сотрудников{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2><i class="fas fa-search"></i> Расширенный поиск сотрудников</h2>
    
    <div class="card mt-4">
        <div class="card-header">
            <h5>Параметры поиска</h5>
        </div>
        <div class="card-body">
            <form id="searchForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="text">Текстовый поиск</label>
                        <input type="text" class="form-control" id="text" name="text" 
                               placeholder="Имя, email, табельный номер...">
                        <small class="form-text text-muted">
                            Поиск по имени, email, табельному номеру
                        </small>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="department_id">Подразделение</label>
                        <select class="form-control" id="department_id" name="department_id">
                            <option value="">Все подразделения</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}">{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="position_id">Должность</label>
                        <select class="form-control" id="position_id" name="position_id">
                            <option value="">Все должности</option>
                            {% for pos in positions %}
                            <option value="{{ pos.id }}">{{ pos.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="status">Статус</label>
                        <select class="form-control" id="status" name="status">
                            <option value="">Все</option>
                            <option value="active">Активный</option>
                            <option value="inactive">Уволен</option>
                            <option value="on_leave">В отпуске</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="hire_year">Год приема</label>
                        <input type="number" class="form-control" id="hire_year" name="hire_year" 
                               placeholder="2024" min="1900" max="2100">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="start_date">Дата приема от</label>
                        <input type="date" class="form-control" id="start_date" name="start_date">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="end_date">Дата приема до</label>
                        <input type="date" class="form-control" id="end_date" name="end_date">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="sort_by">Сортировка</label>
                        <select class="form-control" id="sort_by" name="sort_by">
                            <option value="full_name">По имени</option>
                            <option value="hire_date">По дате приема</option>
                            <option value="email">По email</option>
                            <option value="employee_id">По табельному номеру</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="sort_order">Порядок</label>
                        <select class="form-control" id="sort_order" name="sort_order">
                            <option value="asc">По возрастанию</option>
                            <option value="desc">По убыванию</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label>&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Поиск
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-redo"></i> Сбросить
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="card mt-4" id="statisticsCard" style="display: none;">
        <div class="card-header">
            <h5>Статистика результатов</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-box">
                        <h6>Всего найдено</h6>
                        <h3 id="totalCount">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <h6>Активных</h6>
                        <h3 id="activeCount">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <h6>Уволенных</h6>
                        <h3 id="inactiveCount">0</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-box">
                        <h6>В отпуске</h6>
                        <h3 id="onLeaveCount">0</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mt-4" id="resultsCard" style="display: none;">
        <div class="card-header">
            <h5>Результаты поиска</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ФИО</th>
                            <th>Email</th>
                            <th>Табельный №</th>
                            <th>Подразделение</th>
                            <th>Должность</th>
                            <th>Статус</th>
                            <th>Дата приема</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>
            
            <nav id="paginationNav">
                <ul class="pagination justify-content-center" id="paginationList">
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
let currentPage = 1;

document.getElementById('searchForm').addEventListener('submit', function(e) {
    e.preventDefault();
    currentPage = 1;
    performSearch();
});

function performSearch() {
    const formData = new FormData(document.getElementById('searchForm'));
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    params.append('page', currentPage);
    
    fetch("{{ url_for('search.api_search') }}?" + params.toString())
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            displayStatistics(data.statistics);
            displayPagination(data.pagination);
        })
        .catch(error => {
            console.error('Search error:', error);
            alert('Ошибка при выполнении поиска');
        });
}

function displayResults(data) {
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';
    
    if (data.employees.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Сотрудники не найдены</td></tr>';
        document.getElementById('resultsCard').style.display = 'block';
        return;
    }
    
    data.employees.forEach(emp => {
        const tr = document.createElement('tr');
        
        let statusBadge = '';
        if (emp.status === 'active') statusBadge = '<span class="badge badge-success">Активный</span>';
        else if (emp.status === 'inactive') statusBadge = '<span class="badge badge-secondary">Уволен</span>';
        else if (emp.status === 'on_leave') statusBadge = '<span class="badge badge-warning">В отпуске</span>';
        
        tr.innerHTML = `
            <td>${emp.full_name}</td>
            <td>${emp.email}</td>
            <td>${emp.employee_id}</td>
            <td>${emp.department || '-'}</td>
            <td>${emp.position || '-'}</td>
            <td>${statusBadge}</td>
            <td>${emp.hire_date || '-'}</td>
            <td>
                <a href="/employees/${emp.id}/edit" class="btn btn-sm btn-primary">
                    <i class="fas fa-edit"></i>
                </a>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    document.getElementById('resultsCard').style.display = 'block';
}

function displayStatistics(stats) {
    document.getElementById('totalCount').textContent = stats.total;
    document.getElementById('activeCount').textContent = stats.by_status.active || 0;
    document.getElementById('inactiveCount').textContent = stats.by_status.inactive || 0;
    document.getElementById('onLeaveCount').textContent = stats.by_status.on_leave || 0;
    
    document.getElementById('statisticsCard').style.display = 'block';
}

function displayPagination(pagination) {
    const list = document.getElementById('paginationList');
    list.innerHTML = '';
    
    if (pagination.pages <= 1) {
        return;
    }
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = 'page-item' + (pagination.has_prev ? '' : ' disabled');
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pagination.page - 1}); return false;">Назад</a>`;
    list.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= pagination.pages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === pagination.page ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
        list.appendChild(li);
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = 'page-item' + (pagination.has_next ? '' : ' disabled');
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${pagination.page + 1}); return false;">Вперед</a>`;
    list.appendChild(nextLi);
}

function changePage(page) {
    currentPage = page;
    performSearch();
    window.scrollTo(0, 0);
}

function resetForm() {
    document.getElementById('searchForm').reset();
    document.getElementById('resultsCard').style.display = 'none';
    document.getElementById('statisticsCard').style.display = 'none';
}
</script>

<style>
.stat-box {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}
.stat-box h6 {
    color: #6c757d;
    margin-bottom: 10px;
}
.stat-box h3 {
    color: #007bff;
    margin: 0;
}
</style>
{% endblock %}
