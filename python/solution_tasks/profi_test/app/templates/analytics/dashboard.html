<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитика - {{ current_user.username }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    {% include 'includes/header.html' %}

    <div class="container mt-4">
        <h1><i class="fas fa-chart-line"></i> Аналитика профориентации</h1>
        
        <!-- Quick Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-primary text-white">
                    <div class="card-body">
                        <h5>Всего пользователей</h5>
                        <h3 id="total-users">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-success text-white">
                    <div class="card-body">
                        <h5>Всего тестов</h5>
                        <h3 id="total-tests">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-info text-white">
                    <div class="card-body">
                        <h5>Последние 30 дней</h5>
                        <h3 id="recent-tests">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-warning text-white">
                    <div class="card-body">
                        <h5>Среднее/пользователя</h5>
                        <h3 id="avg-per-user">0</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Распределение по методикам</h5>
                    </div>
                    <div class="card-body">
                        <div id="methodology-chart"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Популярные профессиональные сферы</h5>
                    </div>
                    <div class="card-body">
                        <div id="categories-chart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Тренды прохождения тестов</h5>
                    </div>
                    <div class="card-body">
                        <div id="trends-chart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- User-specific section for admins -->
        {% if current_user.is_admin %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users"></i> Анализ схожести пользователей</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="select-user">Выберите пользователя:</label>
                                <select class="form-control" id="select-user">
                                    <option value="">Выберите пользователя...</option>
                                    <!-- Options will be populated by JS -->
                                </select>
                            </div>
                            <div class="col-md-8">
                                <button class="btn btn-primary" id="load-comparison">Анализировать схожесть</button>
                                <button class="btn btn-info" id="load-user-progress">Прогресс пользователя</button>
                            </div>
                        </div>
                        <div id="comparison-results" class="mt-3"></div>
                        <div id="progress-chart" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- ML Effectiveness for admins -->
        {% if current_user.is_admin %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-brain"></i> Эффективность ML-рекомендаций</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card text-center bg-light">
                                    <div class="card-body">
                                        <h5>Всего рекомендаций</h5>
                                        <h3 id="ml-total-notifications">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center bg-light">
                                    <div class="card-body">
                                        <h5>Прочитано</h5>
                                        <h3 id="ml-read-count">0</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center bg-light">
                                    <div class="card-body">
                                        <h5>Вовлеченность</h5>
                                        <h3 id="ml-engagement-rate">0%</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center bg-light">
                                    <div class="card-body">
                                        <h5>Топ рекомендаций</h5>
                                        <ul id="ml-top-recommendations"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    {% include 'includes/footer.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load general analytics
        async function loadOverview() {
            try {
                const response = await fetch('/api/analytics/overview');
                const data = await response.json();
                
                document.getElementById('total-users').textContent = data.total_users;
                document.getElementById('total-tests').textContent = data.total_tests;
                document.getElementById('recent-tests').textContent = data.recent_tests;
                document.getElementById('avg-per-user').textContent = data.avg_tests_per_user;
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }
        
        // Load charts
        async function loadCharts() {
            try {
                // Methodology distribution
                const methodologyResponse = await fetch('/api/analytics/methodology-distribution');
                const methodologyGraph = await methodologyResponse.json();
                Plotly.newPlot('methodology-chart', JSON.parse(methodologyGraph).data, JSON.parse(methodologyGraph).layout);
                
                // Trends
                const trendsResponse = await fetch('/api/analytics/test-trends');
                const trendsGraph = await trendsResponse.json();
                Plotly.newPlot('trends-chart', JSON.parse(trendsGraph).data, JSON.parse(trendsGraph).layout);
                
                // Dominant categories
                const categoriesResponse = await fetch('/api/analytics/dominant-categories');
                const categoriesGraph = await categoriesResponse.json();
                Plotly.newPlot('categories-chart', JSON.parse(categoriesGraph).data, JSON.parse(categoriesGraph).layout);
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }
        
        // Load ML effectiveness (admin only)
        async function loadMLEffectiveness() {
            try {
                const response = await fetch('/api/analytics/ml-effectiveness');
                const data = await response.json();
                
                if (data.total_ml_notifications !== undefined) {
                    document.getElementById('ml-total-notifications').textContent = data.total_ml_notifications;
                    document.getElementById('ml-read-count').textContent = data.read_count;
                    document.getElementById('ml-engagement-rate').textContent = data.engagement_rate + '%';
                    
                    const topRecList = document.getElementById('ml-top-recommendations');
                    topRecList.innerHTML = '';
                    for (const [prof, count] of Object.entries(data.top_recommendations)) {
                        const li = document.createElement('li');
                        li.textContent = `${prof}: ${count}`;
                        topRecList.appendChild(li);
                    }
                }
            } catch (error) {
                console.error('Error loading ML effectiveness:', error);
            }
        }
        
        // Load users for comparison (admin only)
        async function loadUsersForComparison() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();
                
                const select = document.getElementById('select-user');
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username} (${user.email})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        // Load comparison analysis
        document.getElementById('load-comparison').addEventListener('click', async () => {
            const userId = document.getElementById('select-user').value;
            if (!userId) {
                alert('Пожалуйста, выберите пользователя');
                return;
            }
            
            try {
                const response = await fetch(`/api/analytics/comparison/${userId}`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('comparison-results');
                if (data.similar_users && data.similar_users.length > 0) {
                    let html = '<h5>Схожие пользователи:</h5><ul>';
                    data.similar_users.forEach(user => {
                        html += `<li>${user.username} (ID: ${user.user_id}), схожесть: ${(user.similarity * 100).toFixed(1)}%, основная сфера: ${user.dominant_category}</li>`;
                    });
                    html += '</ul>';
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = '<p>Нет схожих пользователей для отображения</p>';
                }
            } catch (error) {
                console.error('Error loading comparison:', error);
            }
        });
        
        // Load user progress
        document.getElementById('load-user-progress').addEventListener('click', async () => {
            const userId = document.getElementById('select-user').value;
            if (!userId) {
                alert('Пожалуйста, выберите пользователя');
                return;
            }
            
            try {
                const response = await fetch(`/api/analytics/user-progress/${userId}`);
                const graphJson = await response.json();
                
                if (graphJson && typeof graphJson === 'object') {
                    Plotly.newPlot('progress-chart', graphJson.data, graphJson.layout);
                } else {
                    document.getElementById('progress-chart').innerHTML = '<p>Нет данных о прогрессе для этого пользователя</p>';
                }
            } catch (error) {
                console.error('Error loading user progress:', error);
            }
        });
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadOverview();
            loadCharts();
            
            // Check if user is admin by checking if the admin elements exist
            if (document.getElementById('ml-total-notifications')) {
                loadMLEffectiveness();
                loadUsersForComparison();
            }
        });
    </script>
</body>
</html>