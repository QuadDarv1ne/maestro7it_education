{% extends "base.html" %}

{% block title %}Security Audit Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Security Audit Dashboard</h1>
        </div>
    </div>
    
    <!-- Security Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Events</h5>
                    <h2 id="totalEvents" class="display-4">0</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5 class="card-title">Suspicious Activities</h5>
                    <h2 id="suspiciousCount" class="display-4">0</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Critical Events</h5>
                    <h2 id="criticalCount" class="display-4">0</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Suspicious IPs</h5>
                    <h2 id="suspiciousIPs" class="display-4">0</h2>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Security Controls</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <button id="refreshData" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                        <button id="exportReport" class="btn btn-success">
                            <i class="fas fa-file-export"></i> Export Report
                        </button>
                        <button id="clearSuspicious" class="btn btn-warning">
                            <i class="fas fa-broom"></i> Clear Suspicious Flags
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <label for="timeRange" class="me-2">Time Range:</label>
                        <select id="timeRange" class="form-select d-inline-block w-auto">
                            <option value="1">Last 1 Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="12">Last 12 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Event Distribution -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Events by Type</h5>
                </div>
                <div class="card-body">
                    <canvas id="eventTypeChart" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Events by Severity</h5>
                </div>
                <div class="card-body">
                    <canvas id="severityChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Suspicious Activities -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Suspicious Activities</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event Type</th>
                                    <th>User/IP</th>
                                    <th>Reason</th>
                                    <th>Severity</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="suspiciousTable">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Security Events Timeline -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Security Events Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event Type</th>
                                    <th>User</th>
                                    <th>IP Address</th>
                                    <th>Severity</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTable">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global variables
    let eventTypeChart, severityChart;
    let refreshInterval;
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
        setupEventListeners();
        startAutoRefresh();
        loadDashboardData();
    });
    
    function initializeCharts() {
        // Event Type Chart
        const eventTypeCtx = document.getElementById('eventTypeChart').getContext('2d');
        eventTypeChart = new Chart(eventTypeCtx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Severity Chart
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        severityChart = new Chart(severityCtx, {
            type: 'bar',
            data: {
                labels: ['Low', 'Medium', 'High', 'Critical'],
                datasets: [{
                    label: 'Event Count',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 205, 86, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(255, 99, 132, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    function setupEventListeners() {
        document.getElementById('refreshData').addEventListener('click', function() {
            loadDashboardData();
        });
        
        document.getElementById('exportReport').addEventListener('click', function() {
            exportSecurityReport();
        });
        
        document.getElementById('clearSuspicious').addEventListener('click', function() {
            clearSuspiciousFlags();
        });
        
        document.getElementById('timeRange').addEventListener('change', function() {
            loadDashboardData();
        });
    }
    
    function startAutoRefresh() {
        refreshInterval = setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
    }
    
    function loadDashboardData() {
        const hours = document.getElementById('timeRange').value;
        
        // Load security summary
        fetch(`/api/security/audit/summary?hours=${hours}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSummary(data.summary);
                    updateCharts(data.summary);
                }
            })
            .catch(error => {
                showMessage('Error loading summary: ' + error, 'danger');
            });
        
        // Load suspicious activities
        fetch(`/api/security/audit/suspicious?hours=${hours}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateSuspiciousTable(data.suspicious_activities);
                }
            })
            .catch(error => {
                showMessage('Error loading suspicious activities: ' + error, 'danger');
            });
        
        // Load all events
        fetch(`/api/security/audit/events?hours=${hours}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateEventsTable(data.events);
                }
            })
            .catch(error => {
                showMessage('Error loading events: ' + error, 'danger');
            });
    }
    
    function updateSummary(summary) {
        document.getElementById('totalEvents').textContent = summary.total_events || 0;
        document.getElementById('suspiciousCount').textContent = summary.suspicious_activities || 0;
        document.getElementById('suspiciousIPs').textContent = (summary.suspicious_ips || []).length;
        
        // Count critical events
        const criticalCount = (summary.events_by_severity || {})['critical'] || 0;
        document.getElementById('criticalCount').textContent = criticalCount;
    }
    
    function updateCharts(summary) {
        // Update event type chart
        const eventTypes = summary.events_by_type || {};
        const labels = Object.keys(eventTypes);
        const data = Object.values(eventTypes);
        
        eventTypeChart.data.labels = labels;
        eventTypeChart.data.datasets[0].data = data;
        eventTypeChart.update();
        
        // Update severity chart
        const severityCounts = summary.events_by_severity || {};
        severityChart.data.datasets[0].data = [
            severityCounts['low'] || 0,
            severityCounts['medium'] || 0,
            severityCounts['high'] || 0,
            severityCounts['critical'] || 0
        ];
        severityChart.update();
    }
    
    function updateSuspiciousTable(activities) {
        const tableBody = document.getElementById('suspiciousTable');
        tableBody.innerHTML = '';
        
        activities.slice(0, 10).forEach(activity => {
            const row = document.createElement('tr');
            row.className = getSeverityClass(activity.severity);
            
            const timestamp = new Date(activity.timestamp).toLocaleString();
            const userDetails = activity.user_id ? `User ID: ${activity.user_id}` : `IP: ${activity.ip_address}`;
            const reason = activity.details?.suspicion_reason || 'Unknown';
            const details = JSON.stringify(activity.details || {}).substring(0, 100) + '...';
            
            row.innerHTML = `
                <td>${timestamp}</td>
                <td>${activity.event_type}</td>
                <td>${userDetails}</td>
                <td>${reason}</td>
                <td>${activity.severity}</td>
                <td>${details}</td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    function updateEventsTable(events) {
        const tableBody = document.getElementById('eventsTable');
        tableBody.innerHTML = '';
        
        events.slice(0, 50).forEach(event => {
            const row = document.createElement('tr');
            row.className = getSeverityClass(event.severity);
            
            const timestamp = new Date(event.timestamp).toLocaleString();
            const userDetails = event.user_id ? `User ID: ${event.user_id}` : 'N/A';
            const details = JSON.stringify(event.details || {}).substring(0, 100) + '...';
            
            row.innerHTML = `
                <td>${timestamp}</td>
                <td>${event.event_type}</td>
                <td>${userDetails}</td>
                <td>${event.ip_address}</td>
                <td>${event.severity}</td>
                <td>${details}</td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    function getSeverityClass(severity) {
        switch(severity) {
            case 'critical': return 'table-danger';
            case 'high': return 'table-warning';
            case 'medium': return 'table-info';
            case 'low': return 'table-success';
            default: return '';
        }
    }
    
    function exportSecurityReport() {
        const hours = document.getElementById('timeRange').value;
        window.open(`/api/security/audit/report?hours=${hours}`, '_blank');
        showMessage('Report export started', 'success');
    }
    
    function clearSuspiciousFlags() {
        if (confirm('Are you sure you want to clear all suspicious flags?')) {
            fetch('/api/security/audit/clear-suspicious', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Suspicious flags cleared', 'success');
                    loadDashboardData();
                } else {
                    showMessage('Error clearing flags: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showMessage('Error clearing flags: ' + error, 'danger');
            });
        }
    }
    
    function showMessage(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '9999';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            if (alert.parentNode) {
                alert.parentNode.removeChild(alert);
            }
        }, 5000);
    }
</script>
{% endblock %}